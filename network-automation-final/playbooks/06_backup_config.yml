---
- name: Backup Network Device Configurations
  hosts: network
  gather_facts: no
  
  tasks:
    - name: Create backup directory
      ansible.builtin.file:
        path: ./backups
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Get current timestamp
      ansible.builtin.set_fact:
        backup_time: "{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}{{ ansible_date_time.second }}"
      delegate_to: localhost
      run_once: true

    - name: Backup running configuration
      cisco.ios.ios_config:
        backup: yes
        backup_options:
          filename: "{{ inventory_hostname }}_config_{{ backup_time }}.txt"
          dir_path: ./backups

    - name: Get running configuration
      cisco.ios.ios_command:
        commands:
          - show running-config
      register: device_config

    - name: Save configuration to file
      ansible.builtin.copy:
        content: "{{ device_config.stdout[0] }}"
        dest: "./backups/{{ inventory_hostname }}_running_config_{{ backup_time }}.txt"
      delegate_to: localhost

    - name: Get device version information
      cisco.ios.ios_command:
        commands:
          - show version
      register: device_version

    - name: Save version information
      ansible.builtin.copy:
        content: "{{ device_version.stdout[0] }}"
        dest: "./backups/{{ inventory_hostname }}_version_{{ backup_time }}.txt"
      delegate_to: localhost

    - name: Get interface status
      cisco.ios.ios_command:
        commands:
          - show ip interface brief
      register: interface_status

    - name: Save interface status
      ansible.builtin.copy:
        content: "{{ interface_status.stdout[0] }}"
        dest: "./backups/{{ inventory_hostname }}_interfaces_{{ backup_time }}.txt"
      delegate_to: localhost

    - name: Create backup summary
      ansible.builtin.lineinfile:
        path: "./backups/backup_summary_{{ backup_time }}.txt"
        line: "{{ inventory_hostname }}: Backup completed successfully at {{ ansible_date_time.iso8601 }}"
        create: yes
      delegate_to: localhost

    - name: Display backup confirmation
      ansible.builtin.debug:
        msg: "âœ“ Configuration backed up for {{ inventory_hostname }} to ./backups/"

- name: Generate backup report
  hosts: localhost
  gather_facts: yes
  
  tasks:
    - name: List all backup files
      ansible.builtin.find:
        paths: ./backups
        patterns: "*{{ backup_time }}*"
      register: backup_files

    - name: Display backup summary
      ansible.builtin.debug:
        msg: 
          - "=========================================="
          - "Backup Summary"
          - "=========================================="
          - "Backup Time: {{ backup_time }}"
          - "Total Files: {{ backup_files.files | length }}"
          - "Backup Location: ./backups/"
          - "=========================================="